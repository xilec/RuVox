# UI приложение

RuVox — desktop-приложение на PyQt6 для озвучивания технических текстов.

## Компоненты

```
┌─────────────────────────────────────────────────────────────┐
│                      MainWindow                             │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐   │
│  │                   PlayerWidget                       │   │
│  │   [◀] [▶/❚❚] [▶▶]  ═══════●═══════  1:23 / 3:45    │   │
│  └──────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌─────────────────────────────────┐  │
│  │   QueueList      │  │        TextViewer               │  │
│  │                  │  │                                 │  │
│  │  ▶ Текст 1       │  │  # Заголовок                    │  │
│  │    Текст 2       │  │                                 │  │
│  │    Текст 3       │  │  Текст с **подсветкой**         │  │
│  │                  │  │  текущего слова.                │  │
│  └──────────────────┘  └─────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  Status: Готово | Очередь: 3                                │
└─────────────────────────────────────────────────────────────┘
```

## Структура модуля

```
ui/
├── main.py              # Точка входа
├── app.py               # Application класс, системный трей
├── main_window.py       # Главное окно
│
├── widgets/
│   ├── player.py        # Плеер с управлением воспроизведением
│   ├── queue_list.py    # Список очереди
│   └── text_viewer.py   # Просмотр текста с подсветкой (Plain/Markdown/Mermaid)
│
├── dialogs/
│   ├── settings.py      # Диалог настроек
│   └── mermaid_preview.py  # Интерактивный просмотр Mermaid-диаграмм
│
├── services/
│   ├── tts_worker.py    # Фоновый TTS-процессинг
│   ├── storage.py       # Хранение записей и аудио
│   ├── clipboard.py     # Работа с буфером обмена
│   ├── hotkeys.py       # Глобальные горячие клавиши
│   ├── mermaid_renderer.py # Рендеринг Mermaid → SVG/pixmap через QWebEngineView
│   └── cleanup.py       # Очистка старых записей
│
├── utils/
│   └── markdown_mapper.py  # Маппинг позиций для Markdown
│
└── models/
    ├── entry.py         # TextEntry — модель записи
    └── config.py        # UIConfig — настройки приложения
```

## Основные виджеты

### TextViewerWidget

Виджет для отображения текста с поддержкой:
- **Два режима отображения:**
  - `TextFormat.PLAIN` — plain text с видимыми Markdown маркерами
  - `TextFormat.MARKDOWN` — рендеренный HTML с форматированием
- **Подсветка текущего слова** во время воспроизведения
- **Позиционный маппинг** для корректной подсветки в Markdown режиме
- **Автопрокрутка** к текущей позиции
- **Переключение режимов** без перегенерации аудио
- **Mermaid-диаграммы** — рендерятся как картинки в Markdown режиме, клик открывает интерактивный просмотр

**Технические детали:**
- Использует `MarkdownPositionMapper` для перевода `original_pos` → `rendered_pos`
- CharMapping из timestamps: позиции в оригинальном тексте (с Markdown)
- Подсветка через `QTextCursor` с желтым фоном
- Обновление позиции каждые 200ms (5 Hz) от плеера

**Поддерживаемый Markdown:**
- Заголовки (`# H1`, `## H2`)
- Жирный текст (`**bold**`)
- Курсив (`_italic_`)
- Inline код (\`code\`)
- Code blocks (\`\`\`python)
- Mermaid-диаграммы (\`\`\`mermaid) — рендерятся как изображения
- Ссылки (`[text](url)`)
- Списки (`- item`, `1. item`)
- Таблицы

### PlayerWidget

Аудиоплеер на основе `libmpv` (python-mpv):
- Воспроизведение с `scaletempo2` для качественного изменения скорости
- Управление: play/pause, seek, speed (0.5x - 2.0x)
- Обновление позиции через QTimer (200ms)
- Graceful degradation при отсутствии mpv

### QueueListWidget

Список записей в очереди:
- Статусы: PENDING, PROCESSING, READY, ERROR
- Контекстное меню: Play, Regenerate, Delete
- Индикация текущего воспроизводимого элемента

## Разделы

- [Установка](installation.md) — установка и запуск приложения
- [Настройки](configuration.md) — конфигурация и горячие клавиши
- [Архитектура](architecture.md) — детальное описание компонентов

## Зависимости

```
PyQt6>=6.6.0            # UI framework
PyQt6-WebEngine>=6.6.0  # Рендеринг Mermaid-диаграмм
markdown>=3.5           # Рендеринг Markdown
python-mpv>=1.0         # Аудио плеер (libmpv)
dasbus>=1.7             # D-Bus для глобальных хоткеев
torch                   # Silero TTS backend
```
