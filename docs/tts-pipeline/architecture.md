# Архитектура Pipeline

## Этапы обработки

```
Input Text (Markdown/Plain)
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  STAGE 0: PREPROCESSING                                     │
│  - Удаление BOM, невидимых символов                         │
│  - Нормализация пробелов                                    │
│  - Унификация кавычек и тире                                │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  STAGE 1: STRUCTURAL PARSING                                │
│  - Извлечение блоков кода (```...```)                       │
│  - Извлечение inline кода (`...`)                           │
│  - Парсинг markdown структуры                               │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  STAGE 2: NORMALIZATION                                     │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐            │
│  │ English │ │ Abbrev  │ │ Numbers │ │  URLs   │            │
│  │ Words   │ │         │ │         │ │ Paths   │            │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘            │
│       │           │           │           │                 │
│  ┌────┴────┐ ┌────┴────┐ ┌────┴────┐ ┌────┴────┐            │
│  │IT Dict  │ │Abbrev   │ │num2words│ │URL      │            │
│  │+ G2P    │ │Dict     │ │(russian)│ │Parser   │            │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘            │
│                                                             │
│  ┌─────────┐ ┌─────────┐                                    │
│  │ Symbols │ │  Code   │                                    │
│  │Operators│ │Identif. │                                    │
│  └─────────┘ └─────────┘                                    │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  STAGE 3: POST-PROCESSING                                   │
│  - Объединение токенов                                      │
│  - Очистка пробелов                                         │
│  - Финальная нормализация пунктуации                        │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
    Output Text (TTS-ready)
```

## Порядок обработки

Нормализаторы применяются в строгом порядке (от высокого приоритета к низкому):

| # | Тип | Паттерн | Преобразование |
|---|-----|---------|----------------|
| 1 | CODE_BLOCK | ` ```python...``` ` | full/brief mode |
| 2 | INLINE_CODE | `` `code` `` | нормализация содержимого |
| 3 | URL | `https://...` | полное произношение |
| 4 | EMAIL | `user@domain.com` | "собака" для @ |
| 5 | IP_ADDRESS | `192.168.1.1` | числа + "точка" |
| 6 | FILE_PATH | `/home/user/file.txt` | "слэш" для / |
| 7 | VERSION | `v2.3.1` | числа + "точка" |
| 8 | SIZE_UNIT | `100MB` | число + единица |
| 9 | PERCENTAGE | `99.9%` | число + "процентов" |
| 10 | RANGE | `10-20` | "от X до Y" |
| 11 | ABBREVIATION | `API`, `HTTP` | словарь или по буквам |
| 12 | CAMEL_CASE | `getUserData` | разделение + транслитерация |
| 13 | SNAKE_CASE | `get_user_data` | разделение + транслитерация |
| 14 | KEBAB_CASE | `my-component` | разделение + транслитерация |
| 15 | OPERATOR | `->`, `>=` | словесное описание |
| 16 | ENGLISH | `feature` | IT словарь или G2P |
| 17 | NUMBER | `123` | num2words (русский) |
| 18 | RUSSIAN | `привет` | без изменений |

## Почему порядок важен

Порядок предотвращает конфликты:

1. **URL раньше чисел** — `192.168.1.1` обрабатывается как IP, а не как числа
2. **Версии раньше чисел** — `v2.3.1` обрабатывается целиком, а не `2`, `3`, `1` отдельно
3. **camelCase раньше английских слов** — `getUserData` разбивается, а не транслитерируется целиком
4. **Аббревиатуры раньше английских слов** — `API` читается по буквам, а не как слово

## Preprocessing

Входной текст нормализуется перед обработкой:

```python
# BOM
text = text.lstrip('\ufeff')

# Кавычки
text = text.replace('«', '"').replace('»', '"')
text = text.replace('"', '"').replace('"', '"')

# Тире
text = text.replace('—', '-')  # em-dash
text = text.replace('–', '-')  # en-dash

# Пробелы
text = re.sub(r'\n{3,}', '\n\n', text)
text = re.sub(r'[ \t]+', ' ', text)
```

## Postprocessing

После нормализации:

```python
# Множественные пробелы
text = re.sub(r' +', ' ', text)

# Пробелы перед пунктуацией
text = re.sub(r' +([.,!?;:])', r'\1', text)

# Пробелы вокруг переносов
text = re.sub(r'\n +', '\n', text)
text = re.sub(r' +\n', '\n', text)
```

## Markdown обработка

### Заголовки

```markdown
## Установка
```
→ "Установка" (маркеры `#` удаляются)

### Нумерованные списки

```markdown
1. Первый пункт
2. Второй пункт
```
→ "Первое: Первый пункт. Второе: Второй пункт."

### Ссылки

```markdown
[текст](https://example.com)
```
→ "текст эйч ти ти пи эс двоеточие слэш слэш example точка ком"

### Блоки кода

**Full mode:**
```markdown
```python
print("hello")
```
```
→ "принт открывающая скобка кавычка хелло кавычка закрывающая скобка"

**Brief mode:**
→ "далее следует пример кода на пайтон"

## TrackedText

Для отслеживания позиций используется `TrackedText`:

```python
tracked = TrackedText("Hello 123")
tracked.sub(r"\b123\b", "сто двадцать три")

mapping = tracked.build_mapping()
# mapping.get_original_range(6, 10) → (6, 9)  # "123" в оригинале
```

См. [TrackedText](tracked-text.md) для деталей.
